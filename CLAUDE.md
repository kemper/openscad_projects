# OpenSCAD Projects

## Project Structure

- `src/` — OpenSCAD `.scad` source files, organized in subdirectories
- `dist/` — Compiled `.stl` and `.3mf` files (generated by `make build` / `make 3mf`), mirrors `src/` structure
- `scripts/` — Python helper scripts (e.g. `stls_to_3mf.py`)
- `previews/` — Rendered PNG previews (generated by `make previews`), mirrors `src/` structure
- `tmp/` — Temporary files for quick one-off previews
- `.venv/` — Python virtual environment managed by `uv` (contains lib3mf)

## Build Commands

```bash
# Build all .scad files to .stl
make build

# Build all files in one subdirectory
make build dir=shelf

# Build a single file to .stl
make build_one file=src/shelf/shelf.scad

# Generate PNG previews for all files (or one subdirectory)
make previews
make previews dir=shelf

# Generate a single PNG preview to tmp/ for quick verification
make preview file=src/shelf/shelf.scad

# Build a multi-color 3MF for Bambu Studio
make 3mf file=src/shelf/shelf_two_color.scad parts="body:#808080 accent:#4169e1"
```

## Verifying OpenSCAD Output

After writing or modifying a `.scad` file, always generate a PNG preview and visually inspect it before considering the work done:

```bash
make preview file=src/your_subdir/your_file.scad
```

This renders `tmp/preview.png` via OpenSCAD (STL) + F3D (PNG). Claude can read this directly to visually verify the shape.

## Multi-Color 3MF Workflow

To create a multi-color model for Bambu Studio:

1. The `.scad` file must have a `part` variable and render different geometry based on its value:
   ```scad
   part = "all";  // "body", "accent", or "all"
   if (part == "body") { ... }
   else if (part == "accent") { ... }
   else { /* render all for preview */ }
   ```
2. Run `make 3mf` specifying each part name and its hex color:
   ```bash
   make 3mf file=src/shelf/shelf_two_color.scad parts="body:#808080 accent:#4169e1"
   ```
3. The output 3MF in `dist/` has each part as a separate object with color assigned,
   ready for Bambu Studio to map to filament slots.

The `make 3mf` target automatically converts the output through `scripts/bambu_3mf.py`,
which restructures the standard 3MF with Bambu's `model_settings.config` for proper
multi-color extruder assignments and thumbnails via F3D. On first open, Bambu Studio
shows a dismissible "not from Bambu Lab" dialog with a "don't show again" checkbox;
after that, files load silently with all color/extruder assignments preserved.

The converter can also be used standalone:
```bash
# Convert any standard 3MF to Bambu format
.venv/bin/python scripts/bambu_3mf.py -o output_bambu.3mf input.3mf

# Skip thumbnail generation (faster, no F3D needed)
.venv/bin/python scripts/bambu_3mf.py --no-thumbnails -o output_bambu.3mf input.3mf
```

The `scripts/stls_to_3mf.py` script can also be used standalone:
```bash
.venv/bin/python scripts/stls_to_3mf.py -o output.3mf body.stl:#808080 accent.stl:#4169e1
```

## OpenSCAD Conventions

- All configurable parameters should be declared at the top of the file with sensible defaults
- Use millimeters as the unit of measurement
- Use `$fn` for controlling curve smoothness (higher = smoother, slower)
- Prefer `minkowski()` or `offset()` for rounding edges over manual math when appropriate

## Python Environment

This project uses `uv` for Python package management. The virtual environment is at `.venv/`.

```bash
# Install dependencies
uv pip install lib3mf

# Run Python scripts via the venv
.venv/bin/python script.py

# Or in Makefile targets, use $(PYTHON) which points to .venv/bin/python
```

## Installed Tools

- **OpenSCAD**: Version 2026.02.19 (snapshot) — uses Manifold backend by default for fast rendering
- **F3D**: Version 3.4.1 — used for high-quality PNG preview rendering from STL files
- **uv**: Version 0.10.5 — Python package manager
- **lib3mf**: Version 2.5.0 (in .venv) — library for creating/manipulating 3MF files with multi-color support
